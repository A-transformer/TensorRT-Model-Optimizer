# SPDX-FileCopyrightText: Copyright (c) 2024 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import pytest

from modelopt.torch.export.tensorrt_llm_utils import _detect_exclude_modules

weight_keys_all_quantized = set(
    [
        "transformer.layers.1.attention.dense.weight",
        "transformer.layers.1.attention.dense.weight_scaling_factor",
        "transformer.layers.1.attention.dense.activation_scaling_factor",
        "transformer.layers.1.attention.qkv.weight",
        "transformer.layers.1.attention.qkv.weight_scaling_factor",
        "transformer.layers.1.attention.qkv.activation_scaling_factor",
        "transformer.layers.1.attention.kv_cache_scaling_factor",
        "transformer.layers.1.mlp.fc.weight",
        "transformer.layers.1.mlp.fc.weight_scaling_factor",
        "transformer.layers.1.mlp.fc.activation_scaling_factor",
        "transformer.layers.1.mlp.proj.weight",
        "transformer.layers.1.mlp.proj.weight_scaling_factor",
        "transformer.layers.1.mlp.proj.activation_scaling_factor",
        "transformer.layers.2.attention.qkv.weight",
        "transformer.layers.2.attention.qkv.weight_scaling_factor",
        "transformer.layers.2.attention.qkv.activation_scaling_factor",
        "transformer.layers.2.attention.dense.weight",
        "transformer.layers.2.attention.dense.weight_scaling_factor",
        "transformer.layers.2.attention.dense.activation_scaling_factor",
        "transformer.layers.2.attention.kv_cache_scaling_factor",
        "transformer.layers.2.mlp.proj.weight",
        "transformer.layers.2.mlp.proj.weight_scaling_factor",
        "transformer.layers.2.mlp.proj.activation_scaling_factor",
        "transformer.layers.2.mlp.fc.weight",
        "transformer.layers.2.mlp.fc.weight_scaling_factor",
        "transformer.layers.2.mlp.fc.activation_scaling_factor",
    ]
)

expected_all_quantized = set([])

weight_keys_none_quantized = set(
    [
        "transformer.layers.1.attention.dense.weight",
        "transformer.layers.1.attention.qkv.weight",
        "transformer.layers.1.mlp.fc.weight",
        "transformer.layers.1.mlp.proj.weight",
        "transformer.layers.2.attention.qkv.weight",
        "transformer.layers.2.attention.dense.weight",
        "transformer.layers.2.mlp.proj.weight",
        "transformer.layers.2.mlp.fc.weight",
    ]
)

expected_none_quantized = set(
    [
        "transformer*",
    ]
)

weight_keys_layer_non_quantized = set(
    [
        "transformer.layers.1.attention.dense.weight",
        "transformer.layers.1.attention.dense.weight_scaling_factor",
        "transformer.layers.1.attention.dense.activation_scaling_factor",
        "transformer.layers.1.attention.qkv.weight",
        "transformer.layers.1.attention.qkv.weight_scaling_factor",
        "transformer.layers.1.attention.qkv.activation_scaling_factor",
        "transformer.layers.1.attention.kv_cache_scaling_factor",
        "transformer.layers.1.mlp.fc.weight",
        "transformer.layers.1.mlp.fc.weight_scaling_factor",
        "transformer.layers.1.mlp.fc.activation_scaling_factor",
        "transformer.layers.1.mlp.proj.weight",
        "transformer.layers.1.mlp.proj.weight_scaling_factor",
        "transformer.layers.1.mlp.proj.activation_scaling_factor",
        "transformer.layers.2.attention.qkv.weight",
        "transformer.layers.2.attention.dense.weight",
        "transformer.layers.2.mlp.proj.weight",
        "transformer.layers.2.mlp.fc.weight",
    ]
)

expected_layer_non_quantized = set(
    [
        "transformer.layers.2*",
    ]
)

weight_keys_sub_layer_non_quantized = set(
    [
        "transformer.layers.1.attention.dense.weight",
        "transformer.layers.1.attention.dense.weight_scaling_factor",
        "transformer.layers.1.attention.dense.activation_scaling_factor",
        "transformer.layers.1.attention.qkv.weight",
        "transformer.layers.1.attention.kv_cache_scaling_factor",
        "transformer.layers.1.mlp.fc.weight",
        "transformer.layers.1.mlp.proj.weight",
        "transformer.layers.2.attention.qkv.weight",
        "transformer.layers.2.attention.dense.weight",
        "transformer.layers.2.mlp.proj.weight",
        "transformer.layers.2.mlp.fc.weight",
    ]
)

expected_sub_layer_non_quantized = set(
    [
        "transformer.layers.1.attention.qkv",
        "transformer.layers.1.mlp*",
        "transformer.layers.2*",
    ]
)

weight_keys_wildcard_conflict = set(
    [
        "transformer.layers.1.attention.dense.weight",
        "transformer.layers.1.attention.qkv.weight",
        "transformer.layers.1.mlp.fc.weight",
        "transformer.layers.1.mlp.proj.weight",
        "transformer.layers.10.attention.qkv.weight",
        "transformer.layers.10.attention.dense.weight",
        "transformer.layers.10.mlp.proj.weight",
        "transformer.layers.10.mlp.proj.weight_scaling_factor",
        "transformer.layers.10.mlp.proj.activation_scaling_factor",
        "transformer.layers.10.mlp.fc.weight",
        "transformer.layers.10.mlp.fc.weight_scaling_factor",
        "transformer.layers.10.mlp.fc.activation_scaling_factor",
    ]
)

expected_wildcard_conflict = set(
    [
        "transformer.layers.1",
        "transformer.layers.1.*",
        "transformer.layers.10.attention*",
    ]
)


weight_keys_moe = set(
    [
        "transformer.layers.17.attention.dense.weight",
        "transformer.layers.17.attention.kv_cache_scaling_factor",
        "transformer.layers.17.attention.dense.weight_scaling_factor",
        "transformer.layers.17.attention.dense.activation_scaling_factor",
        "transformer.layers.17.attention.qkv.weight",
        "transformer.layers.17.input_layernorm.weight",
        "transformer.layers.17.mlp.fc.weight",
        "transformer.layers.17.mlp.proj.weight",
        "transformer.layers.17.mlp.router.weight",
        "transformer.layers.17.post_layernorm.weight",
    ]
)


expected_moe = set(
    [
        "transformer.layers.17.attention.qkv",
        "transformer.layers.17.input_layernorm",
        "transformer.layers.17.post_layernorm",
        "transformer.layers.17.mlp*",
    ]
)

weight_keys_real_mixtral_8x7b = set(
    [
        "lm_head.weight",
        "transformer.ln_f.weight",
        "transformer.vocab_embedding.weight",
        "transformer.layers.0.attention.dense.weight",
        "transformer.layers.0.attention.kv_cache_scaling_factor",
        "transformer.layers.0.attention.qkv.weight",
        "transformer.layers.0.input_layernorm.weight",
        "transformer.layers.0.mlp.fc.activation_scaling_factor",
        "transformer.layers.0.mlp.fc.weight",
        "transformer.layers.0.mlp.fc.weights_scaling_factor",
        "transformer.layers.0.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.0.mlp.proj.activation_scaling_factor",
        "transformer.layers.0.mlp.proj.weight",
        "transformer.layers.0.mlp.proj.weights_scaling_factor",
        "transformer.layers.0.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.0.mlp.router.weight",
        "transformer.layers.0.post_layernorm.weight",
        "transformer.layers.1.attention.dense.weight",
        "transformer.layers.1.attention.kv_cache_scaling_factor",
        "transformer.layers.1.attention.qkv.weight",
        "transformer.layers.1.input_layernorm.weight",
        "transformer.layers.1.mlp.fc.weight",
        "transformer.layers.1.mlp.proj.weight",
        "transformer.layers.1.mlp.router.weight",
        "transformer.layers.1.post_layernorm.weight",
        "transformer.layers.2.attention.dense.weight",
        "transformer.layers.2.attention.kv_cache_scaling_factor",
        "transformer.layers.2.attention.qkv.weight",
        "transformer.layers.2.input_layernorm.weight",
        "transformer.layers.2.mlp.fc.activation_scaling_factor",
        "transformer.layers.2.mlp.fc.weight",
        "transformer.layers.2.mlp.fc.weights_scaling_factor",
        "transformer.layers.2.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.2.mlp.proj.activation_scaling_factor",
        "transformer.layers.2.mlp.proj.weight",
        "transformer.layers.2.mlp.proj.weights_scaling_factor",
        "transformer.layers.2.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.2.mlp.router.weight",
        "transformer.layers.2.post_layernorm.weight",
        "transformer.layers.3.attention.dense.weight",
        "transformer.layers.3.attention.kv_cache_scaling_factor",
        "transformer.layers.3.attention.qkv.weight",
        "transformer.layers.3.input_layernorm.weight",
        "transformer.layers.3.mlp.fc.activation_scaling_factor",
        "transformer.layers.3.mlp.fc.weight",
        "transformer.layers.3.mlp.fc.weights_scaling_factor",
        "transformer.layers.3.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.3.mlp.proj.activation_scaling_factor",
        "transformer.layers.3.mlp.proj.weight",
        "transformer.layers.3.mlp.proj.weights_scaling_factor",
        "transformer.layers.3.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.3.mlp.router.weight",
        "transformer.layers.3.post_layernorm.weight",
        "transformer.layers.4.attention.dense.weight",
        "transformer.layers.4.attention.kv_cache_scaling_factor",
        "transformer.layers.4.attention.qkv.weight",
        "transformer.layers.4.input_layernorm.weight",
        "transformer.layers.4.mlp.fc.activation_scaling_factor",
        "transformer.layers.4.mlp.fc.weight",
        "transformer.layers.4.mlp.fc.weights_scaling_factor",
        "transformer.layers.4.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.4.mlp.proj.activation_scaling_factor",
        "transformer.layers.4.mlp.proj.weight",
        "transformer.layers.4.mlp.proj.weights_scaling_factor",
        "transformer.layers.4.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.4.mlp.router.weight",
        "transformer.layers.4.post_layernorm.weight",
        "transformer.layers.5.attention.dense.weight",
        "transformer.layers.5.attention.kv_cache_scaling_factor",
        "transformer.layers.5.attention.qkv.weight",
        "transformer.layers.5.input_layernorm.weight",
        "transformer.layers.5.mlp.fc.activation_scaling_factor",
        "transformer.layers.5.mlp.fc.weight",
        "transformer.layers.5.mlp.fc.weights_scaling_factor",
        "transformer.layers.5.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.5.mlp.proj.activation_scaling_factor",
        "transformer.layers.5.mlp.proj.weight",
        "transformer.layers.5.mlp.proj.weights_scaling_factor",
        "transformer.layers.5.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.5.mlp.router.weight",
        "transformer.layers.5.post_layernorm.weight",
        "transformer.layers.6.attention.dense.weight",
        "transformer.layers.6.attention.kv_cache_scaling_factor",
        "transformer.layers.6.attention.qkv.weight",
        "transformer.layers.6.input_layernorm.weight",
        "transformer.layers.6.mlp.fc.activation_scaling_factor",
        "transformer.layers.6.mlp.fc.weight",
        "transformer.layers.6.mlp.fc.weights_scaling_factor",
        "transformer.layers.6.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.6.mlp.proj.activation_scaling_factor",
        "transformer.layers.6.mlp.proj.weight",
        "transformer.layers.6.mlp.proj.weights_scaling_factor",
        "transformer.layers.6.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.6.mlp.router.weight",
        "transformer.layers.6.post_layernorm.weight",
        "transformer.layers.7.attention.dense.weight",
        "transformer.layers.7.attention.kv_cache_scaling_factor",
        "transformer.layers.7.attention.qkv.weight",
        "transformer.layers.7.input_layernorm.weight",
        "transformer.layers.7.mlp.fc.activation_scaling_factor",
        "transformer.layers.7.mlp.fc.weight",
        "transformer.layers.7.mlp.fc.weights_scaling_factor",
        "transformer.layers.7.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.7.mlp.proj.activation_scaling_factor",
        "transformer.layers.7.mlp.proj.weight",
        "transformer.layers.7.mlp.proj.weights_scaling_factor",
        "transformer.layers.7.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.7.mlp.router.weight",
        "transformer.layers.7.post_layernorm.weight",
        "transformer.layers.8.attention.dense.weight",
        "transformer.layers.8.attention.kv_cache_scaling_factor",
        "transformer.layers.8.attention.qkv.weight",
        "transformer.layers.8.input_layernorm.weight",
        "transformer.layers.8.mlp.fc.activation_scaling_factor",
        "transformer.layers.8.mlp.fc.weight",
        "transformer.layers.8.mlp.fc.weights_scaling_factor",
        "transformer.layers.8.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.8.mlp.proj.activation_scaling_factor",
        "transformer.layers.8.mlp.proj.weight",
        "transformer.layers.8.mlp.proj.weights_scaling_factor",
        "transformer.layers.8.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.8.mlp.router.weight",
        "transformer.layers.8.post_layernorm.weight",
        "transformer.layers.9.attention.dense.weight",
        "transformer.layers.9.attention.kv_cache_scaling_factor",
        "transformer.layers.9.attention.qkv.weight",
        "transformer.layers.9.input_layernorm.weight",
        "transformer.layers.9.mlp.fc.activation_scaling_factor",
        "transformer.layers.9.mlp.fc.weight",
        "transformer.layers.9.mlp.fc.weights_scaling_factor",
        "transformer.layers.9.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.9.mlp.proj.activation_scaling_factor",
        "transformer.layers.9.mlp.proj.weight",
        "transformer.layers.9.mlp.proj.weights_scaling_factor",
        "transformer.layers.9.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.9.mlp.router.weight",
        "transformer.layers.9.post_layernorm.weight",
        "transformer.layers.10.attention.dense.weight",
        "transformer.layers.10.attention.kv_cache_scaling_factor",
        "transformer.layers.10.attention.qkv.weight",
        "transformer.layers.10.input_layernorm.weight",
        "transformer.layers.10.mlp.fc.activation_scaling_factor",
        "transformer.layers.10.mlp.fc.weight",
        "transformer.layers.10.mlp.fc.weights_scaling_factor",
        "transformer.layers.10.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.10.mlp.proj.activation_scaling_factor",
        "transformer.layers.10.mlp.proj.weight",
        "transformer.layers.10.mlp.proj.weights_scaling_factor",
        "transformer.layers.10.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.10.mlp.router.weight",
        "transformer.layers.10.post_layernorm.weight",
        "transformer.layers.11.attention.dense.weight",
        "transformer.layers.11.attention.kv_cache_scaling_factor",
        "transformer.layers.11.attention.qkv.weight",
        "transformer.layers.11.input_layernorm.weight",
        "transformer.layers.11.mlp.fc.activation_scaling_factor",
        "transformer.layers.11.mlp.fc.weight",
        "transformer.layers.11.mlp.fc.weights_scaling_factor",
        "transformer.layers.11.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.11.mlp.proj.activation_scaling_factor",
        "transformer.layers.11.mlp.proj.weight",
        "transformer.layers.11.mlp.proj.weights_scaling_factor",
        "transformer.layers.11.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.11.mlp.router.weight",
        "transformer.layers.11.post_layernorm.weight",
        "transformer.layers.12.attention.dense.weight",
        "transformer.layers.12.attention.kv_cache_scaling_factor",
        "transformer.layers.12.attention.qkv.weight",
        "transformer.layers.12.input_layernorm.weight",
        "transformer.layers.12.mlp.fc.activation_scaling_factor",
        "transformer.layers.12.mlp.fc.weight",
        "transformer.layers.12.mlp.fc.weights_scaling_factor",
        "transformer.layers.12.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.12.mlp.proj.activation_scaling_factor",
        "transformer.layers.12.mlp.proj.weight",
        "transformer.layers.12.mlp.proj.weights_scaling_factor",
        "transformer.layers.12.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.12.mlp.router.weight",
        "transformer.layers.12.post_layernorm.weight",
        "transformer.layers.13.attention.dense.weight",
        "transformer.layers.13.attention.kv_cache_scaling_factor",
        "transformer.layers.13.attention.qkv.weight",
        "transformer.layers.13.input_layernorm.weight",
        "transformer.layers.13.mlp.fc.activation_scaling_factor",
        "transformer.layers.13.mlp.fc.weight",
        "transformer.layers.13.mlp.fc.weights_scaling_factor",
        "transformer.layers.13.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.13.mlp.proj.activation_scaling_factor",
        "transformer.layers.13.mlp.proj.weight",
        "transformer.layers.13.mlp.proj.weights_scaling_factor",
        "transformer.layers.13.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.13.mlp.router.weight",
        "transformer.layers.13.post_layernorm.weight",
        "transformer.layers.14.attention.dense.weight",
        "transformer.layers.14.attention.kv_cache_scaling_factor",
        "transformer.layers.14.attention.qkv.weight",
        "transformer.layers.14.input_layernorm.weight",
        "transformer.layers.14.mlp.fc.weight",
        "transformer.layers.14.mlp.proj.weight",
        "transformer.layers.14.mlp.router.weight",
        "transformer.layers.14.post_layernorm.weight",
        "transformer.layers.15.attention.dense.weight",
        "transformer.layers.15.attention.kv_cache_scaling_factor",
        "transformer.layers.15.attention.qkv.weight",
        "transformer.layers.15.input_layernorm.weight",
        "transformer.layers.15.mlp.fc.activation_scaling_factor",
        "transformer.layers.15.mlp.fc.weight",
        "transformer.layers.15.mlp.fc.weights_scaling_factor",
        "transformer.layers.15.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.15.mlp.proj.activation_scaling_factor",
        "transformer.layers.15.mlp.proj.weight",
        "transformer.layers.15.mlp.proj.weights_scaling_factor",
        "transformer.layers.15.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.15.mlp.router.weight",
        "transformer.layers.15.post_layernorm.weight",
        "transformer.layers.16.attention.dense.weight",
        "transformer.layers.16.attention.kv_cache_scaling_factor",
        "transformer.layers.16.attention.qkv.weight",
        "transformer.layers.16.input_layernorm.weight",
        "transformer.layers.16.mlp.fc.activation_scaling_factor",
        "transformer.layers.16.mlp.fc.weight",
        "transformer.layers.16.mlp.fc.weights_scaling_factor",
        "transformer.layers.16.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.16.mlp.proj.activation_scaling_factor",
        "transformer.layers.16.mlp.proj.weight",
        "transformer.layers.16.mlp.proj.weights_scaling_factor",
        "transformer.layers.16.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.16.mlp.router.weight",
        "transformer.layers.16.post_layernorm.weight",
        "transformer.layers.17.attention.dense.weight",
        "transformer.layers.17.attention.kv_cache_scaling_factor",
        "transformer.layers.17.attention.qkv.weight",
        "transformer.layers.17.input_layernorm.weight",
        "transformer.layers.17.mlp.fc.weight",
        "transformer.layers.17.mlp.proj.weight",
        "transformer.layers.17.mlp.router.weight",
        "transformer.layers.17.post_layernorm.weight",
        "transformer.layers.18.attention.dense.weight",
        "transformer.layers.18.attention.kv_cache_scaling_factor",
        "transformer.layers.18.attention.qkv.weight",
        "transformer.layers.18.input_layernorm.weight",
        "transformer.layers.18.mlp.fc.activation_scaling_factor",
        "transformer.layers.18.mlp.fc.weight",
        "transformer.layers.18.mlp.fc.weights_scaling_factor",
        "transformer.layers.18.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.18.mlp.proj.activation_scaling_factor",
        "transformer.layers.18.mlp.proj.weight",
        "transformer.layers.18.mlp.proj.weights_scaling_factor",
        "transformer.layers.18.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.18.mlp.router.weight",
        "transformer.layers.18.post_layernorm.weight",
        "transformer.layers.19.attention.dense.weight",
        "transformer.layers.19.attention.kv_cache_scaling_factor",
        "transformer.layers.19.attention.qkv.weight",
        "transformer.layers.19.input_layernorm.weight",
        "transformer.layers.19.mlp.fc.activation_scaling_factor",
        "transformer.layers.19.mlp.fc.weight",
        "transformer.layers.19.mlp.fc.weights_scaling_factor",
        "transformer.layers.19.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.19.mlp.proj.activation_scaling_factor",
        "transformer.layers.19.mlp.proj.weight",
        "transformer.layers.19.mlp.proj.weights_scaling_factor",
        "transformer.layers.19.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.19.mlp.router.weight",
        "transformer.layers.19.post_layernorm.weight",
        "transformer.layers.20.attention.dense.weight",
        "transformer.layers.20.attention.kv_cache_scaling_factor",
        "transformer.layers.20.attention.qkv.weight",
        "transformer.layers.20.input_layernorm.weight",
        "transformer.layers.20.mlp.fc.activation_scaling_factor",
        "transformer.layers.20.mlp.fc.weight",
        "transformer.layers.20.mlp.fc.weights_scaling_factor",
        "transformer.layers.20.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.20.mlp.proj.activation_scaling_factor",
        "transformer.layers.20.mlp.proj.weight",
        "transformer.layers.20.mlp.proj.weights_scaling_factor",
        "transformer.layers.20.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.20.mlp.router.weight",
        "transformer.layers.20.post_layernorm.weight",
        "transformer.layers.21.attention.dense.weight",
        "transformer.layers.21.attention.kv_cache_scaling_factor",
        "transformer.layers.21.attention.qkv.weight",
        "transformer.layers.21.input_layernorm.weight",
        "transformer.layers.21.mlp.fc.activation_scaling_factor",
        "transformer.layers.21.mlp.fc.weight",
        "transformer.layers.21.mlp.fc.weights_scaling_factor",
        "transformer.layers.21.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.21.mlp.proj.activation_scaling_factor",
        "transformer.layers.21.mlp.proj.weight",
        "transformer.layers.21.mlp.proj.weights_scaling_factor",
        "transformer.layers.21.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.21.mlp.router.weight",
        "transformer.layers.21.post_layernorm.weight",
        "transformer.layers.22.attention.dense.weight",
        "transformer.layers.22.attention.kv_cache_scaling_factor",
        "transformer.layers.22.attention.qkv.weight",
        "transformer.layers.22.input_layernorm.weight",
        "transformer.layers.22.mlp.fc.activation_scaling_factor",
        "transformer.layers.22.mlp.fc.weight",
        "transformer.layers.22.mlp.fc.weights_scaling_factor",
        "transformer.layers.22.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.22.mlp.proj.activation_scaling_factor",
        "transformer.layers.22.mlp.proj.weight",
        "transformer.layers.22.mlp.proj.weights_scaling_factor",
        "transformer.layers.22.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.22.mlp.router.weight",
        "transformer.layers.22.post_layernorm.weight",
        "transformer.layers.23.attention.dense.weight",
        "transformer.layers.23.attention.kv_cache_scaling_factor",
        "transformer.layers.23.attention.qkv.weight",
        "transformer.layers.23.input_layernorm.weight",
        "transformer.layers.23.mlp.fc.activation_scaling_factor",
        "transformer.layers.23.mlp.fc.weight",
        "transformer.layers.23.mlp.fc.weights_scaling_factor",
        "transformer.layers.23.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.23.mlp.proj.activation_scaling_factor",
        "transformer.layers.23.mlp.proj.weight",
        "transformer.layers.23.mlp.proj.weights_scaling_factor",
        "transformer.layers.23.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.23.mlp.router.weight",
        "transformer.layers.23.post_layernorm.weight",
        "transformer.layers.24.attention.dense.weight",
        "transformer.layers.24.attention.kv_cache_scaling_factor",
        "transformer.layers.24.attention.qkv.weight",
        "transformer.layers.24.input_layernorm.weight",
        "transformer.layers.24.mlp.fc.activation_scaling_factor",
        "transformer.layers.24.mlp.fc.weight",
        "transformer.layers.24.mlp.fc.weights_scaling_factor",
        "transformer.layers.24.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.24.mlp.proj.activation_scaling_factor",
        "transformer.layers.24.mlp.proj.weight",
        "transformer.layers.24.mlp.proj.weights_scaling_factor",
        "transformer.layers.24.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.24.mlp.router.weight",
        "transformer.layers.24.post_layernorm.weight",
        "transformer.layers.25.attention.dense.weight",
        "transformer.layers.25.attention.kv_cache_scaling_factor",
        "transformer.layers.25.attention.qkv.weight",
        "transformer.layers.25.input_layernorm.weight",
        "transformer.layers.25.mlp.fc.activation_scaling_factor",
        "transformer.layers.25.mlp.fc.weight",
        "transformer.layers.25.mlp.fc.weights_scaling_factor",
        "transformer.layers.25.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.25.mlp.proj.activation_scaling_factor",
        "transformer.layers.25.mlp.proj.weight",
        "transformer.layers.25.mlp.proj.weights_scaling_factor",
        "transformer.layers.25.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.25.mlp.router.weight",
        "transformer.layers.25.post_layernorm.weight",
        "transformer.layers.26.attention.dense.weight",
        "transformer.layers.26.attention.kv_cache_scaling_factor",
        "transformer.layers.26.attention.qkv.weight",
        "transformer.layers.26.input_layernorm.weight",
        "transformer.layers.26.mlp.fc.activation_scaling_factor",
        "transformer.layers.26.mlp.fc.weight",
        "transformer.layers.26.mlp.fc.weights_scaling_factor",
        "transformer.layers.26.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.26.mlp.proj.activation_scaling_factor",
        "transformer.layers.26.mlp.proj.weight",
        "transformer.layers.26.mlp.proj.weights_scaling_factor",
        "transformer.layers.26.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.26.mlp.router.weight",
        "transformer.layers.26.post_layernorm.weight",
        "transformer.layers.27.attention.dense.weight",
        "transformer.layers.27.attention.kv_cache_scaling_factor",
        "transformer.layers.27.attention.qkv.weight",
        "transformer.layers.27.input_layernorm.weight",
        "transformer.layers.27.mlp.fc.activation_scaling_factor",
        "transformer.layers.27.mlp.fc.weight",
        "transformer.layers.27.mlp.fc.weights_scaling_factor",
        "transformer.layers.27.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.27.mlp.proj.activation_scaling_factor",
        "transformer.layers.27.mlp.proj.weight",
        "transformer.layers.27.mlp.proj.weights_scaling_factor",
        "transformer.layers.27.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.27.mlp.router.weight",
        "transformer.layers.27.post_layernorm.weight",
        "transformer.layers.28.attention.dense.weight",
        "transformer.layers.28.attention.kv_cache_scaling_factor",
        "transformer.layers.28.attention.qkv.weight",
        "transformer.layers.28.input_layernorm.weight",
        "transformer.layers.28.mlp.fc.activation_scaling_factor",
        "transformer.layers.28.mlp.fc.weight",
        "transformer.layers.28.mlp.fc.weights_scaling_factor",
        "transformer.layers.28.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.28.mlp.proj.activation_scaling_factor",
        "transformer.layers.28.mlp.proj.weight",
        "transformer.layers.28.mlp.proj.weights_scaling_factor",
        "transformer.layers.28.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.28.mlp.router.weight",
        "transformer.layers.28.post_layernorm.weight",
        "transformer.layers.29.attention.dense.weight",
        "transformer.layers.29.attention.kv_cache_scaling_factor",
        "transformer.layers.29.attention.qkv.weight",
        "transformer.layers.29.input_layernorm.weight",
        "transformer.layers.29.mlp.fc.weight",
        "transformer.layers.29.mlp.proj.weight",
        "transformer.layers.29.mlp.router.weight",
        "transformer.layers.29.post_layernorm.weight",
        "transformer.layers.30.attention.dense.weight",
        "transformer.layers.30.attention.kv_cache_scaling_factor",
        "transformer.layers.30.attention.qkv.weight",
        "transformer.layers.30.input_layernorm.weight",
        "transformer.layers.30.mlp.fc.activation_scaling_factor",
        "transformer.layers.30.mlp.fc.weight",
        "transformer.layers.30.mlp.fc.weights_scaling_factor",
        "transformer.layers.30.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.30.mlp.proj.activation_scaling_factor",
        "transformer.layers.30.mlp.proj.weight",
        "transformer.layers.30.mlp.proj.weights_scaling_factor",
        "transformer.layers.30.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.30.mlp.router.weight",
        "transformer.layers.30.post_layernorm.weight",
        "transformer.layers.31.attention.dense.weight",
        "transformer.layers.31.attention.kv_cache_scaling_factor",
        "transformer.layers.31.attention.qkv.weight",
        "transformer.layers.31.input_layernorm.weight",
        "transformer.layers.31.mlp.fc.activation_scaling_factor",
        "transformer.layers.31.mlp.fc.weight",
        "transformer.layers.31.mlp.fc.weights_scaling_factor",
        "transformer.layers.31.mlp.fc.weights_scaling_factor_2",
        "transformer.layers.31.mlp.proj.activation_scaling_factor",
        "transformer.layers.31.mlp.proj.weight",
        "transformer.layers.31.mlp.proj.weights_scaling_factor",
        "transformer.layers.31.mlp.proj.weights_scaling_factor_2",
        "transformer.layers.31.mlp.router.weight",
        "transformer.layers.31.post_layernorm.weight",
    ]
)

expected_real_mixtral_8x7b = set(
    [
        "lm_head",
        "transformer.ln_f",
        "transformer.vocab_embedding",
        "transformer.layers.0.attention*",
        "transformer.layers.0.input_layernorm",
        "transformer.layers.0.mlp.router",
        "transformer.layers.0.post_layernorm",
        "transformer.layers.1",
        "transformer.layers.1.*",
        "transformer.layers.2.attention*",
        "transformer.layers.2.input_layernorm",
        "transformer.layers.2.mlp.router",
        "transformer.layers.2.post_layernorm",
        "transformer.layers.3.attention*",
        "transformer.layers.3.input_layernorm",
        "transformer.layers.3.mlp.router",
        "transformer.layers.3.post_layernorm",
        "transformer.layers.4.attention*",
        "transformer.layers.4.input_layernorm",
        "transformer.layers.4.mlp.router",
        "transformer.layers.4.post_layernorm",
        "transformer.layers.5.attention*",
        "transformer.layers.5.input_layernorm",
        "transformer.layers.5.mlp.router",
        "transformer.layers.5.post_layernorm",
        "transformer.layers.6.attention*",
        "transformer.layers.6.input_layernorm",
        "transformer.layers.6.mlp.router",
        "transformer.layers.6.post_layernorm",
        "transformer.layers.7.attention*",
        "transformer.layers.7.input_layernorm",
        "transformer.layers.7.mlp.router",
        "transformer.layers.7.post_layernorm",
        "transformer.layers.8.attention*",
        "transformer.layers.8.input_layernorm",
        "transformer.layers.8.mlp.router",
        "transformer.layers.8.post_layernorm",
        "transformer.layers.9.attention*",
        "transformer.layers.9.input_layernorm",
        "transformer.layers.9.mlp.router",
        "transformer.layers.9.post_layernorm",
        "transformer.layers.10.attention*",
        "transformer.layers.10.input_layernorm",
        "transformer.layers.10.mlp.router",
        "transformer.layers.10.post_layernorm",
        "transformer.layers.11.attention*",
        "transformer.layers.11.input_layernorm",
        "transformer.layers.11.mlp.router",
        "transformer.layers.11.post_layernorm",
        "transformer.layers.12.attention*",
        "transformer.layers.12.input_layernorm",
        "transformer.layers.12.mlp.router",
        "transformer.layers.12.post_layernorm",
        "transformer.layers.13.attention*",
        "transformer.layers.13.input_layernorm",
        "transformer.layers.13.mlp.router",
        "transformer.layers.13.post_layernorm",
        "transformer.layers.14*",
        "transformer.layers.15.attention*",
        "transformer.layers.15.input_layernorm",
        "transformer.layers.15.mlp.router",
        "transformer.layers.15.post_layernorm",
        "transformer.layers.16.attention*",
        "transformer.layers.16.input_layernorm",
        "transformer.layers.16.mlp.router",
        "transformer.layers.16.post_layernorm",
        "transformer.layers.17*",
        "transformer.layers.18.attention*",
        "transformer.layers.18.input_layernorm",
        "transformer.layers.18.mlp.router",
        "transformer.layers.18.post_layernorm",
        "transformer.layers.19.attention*",
        "transformer.layers.19.input_layernorm",
        "transformer.layers.19.mlp.router",
        "transformer.layers.19.post_layernorm",
        "transformer.layers.20.attention*",
        "transformer.layers.20.input_layernorm",
        "transformer.layers.20.mlp.router",
        "transformer.layers.20.post_layernorm",
        "transformer.layers.21.attention*",
        "transformer.layers.21.input_layernorm",
        "transformer.layers.21.mlp.router",
        "transformer.layers.21.post_layernorm",
        "transformer.layers.22.attention*",
        "transformer.layers.22.input_layernorm",
        "transformer.layers.22.mlp.router",
        "transformer.layers.22.post_layernorm",
        "transformer.layers.23.attention*",
        "transformer.layers.23.input_layernorm",
        "transformer.layers.23.mlp.router",
        "transformer.layers.23.post_layernorm",
        "transformer.layers.24.attention*",
        "transformer.layers.24.input_layernorm",
        "transformer.layers.24.mlp.router",
        "transformer.layers.24.post_layernorm",
        "transformer.layers.25.attention*",
        "transformer.layers.25.input_layernorm",
        "transformer.layers.25.mlp.router",
        "transformer.layers.25.post_layernorm",
        "transformer.layers.26.attention*",
        "transformer.layers.26.input_layernorm",
        "transformer.layers.26.mlp.router",
        "transformer.layers.26.post_layernorm",
        "transformer.layers.27.attention*",
        "transformer.layers.27.input_layernorm",
        "transformer.layers.27.mlp.router",
        "transformer.layers.27.post_layernorm",
        "transformer.layers.28.attention*",
        "transformer.layers.28.input_layernorm",
        "transformer.layers.28.mlp.router",
        "transformer.layers.28.post_layernorm",
        "transformer.layers.29*",
        "transformer.layers.30.attention*",
        "transformer.layers.30.input_layernorm",
        "transformer.layers.30.mlp.router",
        "transformer.layers.30.post_layernorm",
        "transformer.layers.31.attention*",
        "transformer.layers.31.input_layernorm",
        "transformer.layers.31.mlp.router",
        "transformer.layers.31.post_layernorm",
    ]
)


@pytest.mark.parametrize(
    "weight_keys, expected",
    [
        (weight_keys_all_quantized, expected_all_quantized),
        (weight_keys_none_quantized, expected_none_quantized),
        (weight_keys_layer_non_quantized, expected_layer_non_quantized),
        (weight_keys_sub_layer_non_quantized, expected_sub_layer_non_quantized),
        (weight_keys_wildcard_conflict, expected_wildcard_conflict),
        (weight_keys_moe, expected_moe),
        (weight_keys_real_mixtral_8x7b, expected_real_mixtral_8x7b),
    ],
    ids=[
        "all_quantized",
        "none_quantized",
        "layer_non_quantized",
        "sub_layer_non_quantized",
        "wildcard_conflict",
        "moe",
        "mixtral_8x7b",
    ],
)
def test_torch_export_exclude_modules(weight_keys, expected):
    exclude_modules = _detect_exclude_modules(weight_keys)

    actual_set = set(list(exclude_modules))
    expected_set = set(list(expected))

    only_actual = actual_set - expected_set
    only_expected = expected_set - actual_set

    for a in actual_set:
        print(f"In actual: {a}")

    for e in expected_set:
        print(f"In expected: {e}")

    assert only_actual == only_expected, (
        f"Only in actual: {only_actual}. Only in expected: {only_expected}"
    )
